<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Code Memory Dashboard</title>
  <style>
    :root {
      --bg-primary: #1a1a2e;
      --bg-secondary: #16213e;
      --bg-card: #0f3460;
      --text-primary: #e6e6e6;
      --text-secondary: #a0a0a0;
      --accent: #e94560;
      --accent-secondary: #533483;
      --success: #4ade80;
      --warning: #fbbf24;
      --border: rgba(255, 255, 255, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 30px;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .logo-icon {
      font-size: 2rem;
    }

    .refresh-btn {
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .refresh-btn:hover {
      background: var(--accent);
    }

    .refresh-btn.loading {
      opacity: 0.6;
      pointer-events: none;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
    }

    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 8px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .search-container {
      margin-bottom: 30px;
    }

    .search-input {
      width: 100%;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 1rem;
    }

    .search-input::placeholder {
      color: var(--text-secondary);
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
    }

    @media (max-width: 900px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    .section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--border);
    }

    .section-title {
      font-size: 1.2rem;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .session-list {
      list-style: none;
    }

    .session-item {
      padding: 16px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }

    .session-item:hover {
      border-color: var(--accent);
    }

    .session-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .session-id {
      font-family: monospace;
      font-size: 0.9rem;
      color: var(--accent);
    }

    .session-time {
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .session-meta {
      display: flex;
      gap: 16px;
      color: var(--text-secondary);
      font-size: 0.85rem;
    }

    .shared-item {
      padding: 16px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shared-type {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .shared-icon {
      font-size: 1.5rem;
    }

    .shared-count {
      background: var(--accent);
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
    }

    .timeline-container {
      margin-top: 30px;
    }

    .timeline-bar {
      display: flex;
      gap: 4px;
      height: 60px;
      align-items: flex-end;
    }

    .timeline-day {
      flex: 1;
      background: var(--accent);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      transition: opacity 0.2s;
      position: relative;
    }

    .timeline-day:hover {
      opacity: 0.8;
    }

    .timeline-day:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.8rem;
      white-space: nowrap;
      z-index: 10;
    }

    .timeline-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      color: var(--text-secondary);
      font-size: 0.8rem;
    }

    .endless-status {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 16px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }

    .status-indicator.active {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }

    .status-indicator.inactive {
      background: var(--text-secondary);
    }

    .progress-bar {
      height: 8px;
      background: var(--bg-primary);
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
      border-radius: 4px;
      transition: width 0.3s;
    }

    .loading-spinner {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .error-message {
      background: rgba(233, 69, 96, 0.2);
      border: 1px solid var(--accent);
      padding: 16px;
      border-radius: 8px;
      color: var(--accent);
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-success {
      background: rgba(74, 222, 128, 0.2);
      color: var(--success);
    }

    .badge-warning {
      background: rgba(251, 191, 36, 0.2);
      color: var(--warning);
    }

    /* Memory Level Navigation */
    .level-nav {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .level-tab {
      padding: 12px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 80px;
    }

    .level-tab:hover {
      border-color: var(--accent);
    }

    .level-tab.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .level-tab .level-name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .level-tab .level-count {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .level-tab.active .level-count {
      color: rgba(255, 255, 255, 0.8);
    }

    .level-description {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-bottom: 16px;
      padding: 12px;
      background: var(--bg-card);
      border-radius: 8px;
    }

    .level-pipeline {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .pipeline-step {
      padding: 8px 16px;
      background: var(--bg-card);
      border-radius: 20px;
      font-size: 0.8rem;
      opacity: 0.5;
    }

    .pipeline-step.active {
      opacity: 1;
      background: var(--accent);
    }

    .pipeline-arrow {
      color: var(--text-secondary);
    }

    .event-card {
      padding: 16px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 12px;
      border: 1px solid transparent;
      transition: all 0.2s;
    }

    .event-card:hover {
      border-color: var(--accent);
    }

    .event-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 8px;
    }

    .event-type.user_prompt {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .event-type.agent_response {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
    }

    .event-type.tool_observation {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    .event-type.session_summary {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }

    .event-content {
      margin-top: 8px;
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .load-more-btn {
      width: 100%;
      padding: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      color: var(--text-primary);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 16px;
    }

    .load-more-btn:hover {
      border-color: var(--accent);
    }

    .load-more-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span class="logo-icon">üß†</span>
        <span>Code Memory Dashboard</span>
      </div>
      <button class="refresh-btn" onclick="refreshData()">
        <span id="refresh-icon">üîÑ</span>
        <span>Refresh</span>
      </button>
    </header>

    <div id="stats-container" class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="stat-events">-</div>
        <div class="stat-label">Total Events</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-sessions">-</div>
        <div class="stat-label">Sessions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-shared">-</div>
        <div class="stat-label">Shared Entries</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-vectors">-</div>
        <div class="stat-label">Vectors</div>
      </div>
    </div>

    <div class="search-container">
      <input
        type="text"
        class="search-input"
        placeholder="üîç Search memories..."
        id="search-input"
        onkeyup="handleSearch(event)"
      >
    </div>

    <div id="search-results" style="display: none; margin-bottom: 30px;">
      <div class="section">
        <h2 class="section-title">üîç Search Results</h2>
        <div id="search-results-content"></div>
      </div>
    </div>

    <!-- Memory Level Explorer -->
    <div class="section" style="margin-bottom: 30px;">
      <h2 class="section-title">üéØ Memory Level Explorer</h2>

      <!-- Pipeline Visualization -->
      <div class="level-pipeline" id="level-pipeline">
        <span class="pipeline-step active" data-level="L0">L0 Raw</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step" data-level="L1">L1 Structured</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step" data-level="L2">L2 Validated</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step" data-level="L3">L3 Verified</span>
        <span class="pipeline-arrow">‚Üí</span>
        <span class="pipeline-step" data-level="L4">L4 Active</span>
      </div>

      <!-- Level Tabs -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <div class="level-nav" id="level-nav" style="flex: 1;">
          <div class="level-tab active" data-level="L0" onclick="selectLevel('L0')">
            <span class="level-name">L0</span>
            <span class="level-count" id="level-count-L0">0</span>
          </div>
          <div class="level-tab" data-level="L1" onclick="selectLevel('L1')">
            <span class="level-name">L1</span>
            <span class="level-count" id="level-count-L1">0</span>
          </div>
          <div class="level-tab" data-level="L2" onclick="selectLevel('L2')">
            <span class="level-name">L2</span>
            <span class="level-count" id="level-count-L2">0</span>
          </div>
            <div class="level-tab" data-level="L3" onclick="selectLevel('L3')">
              <span class="level-name">L3</span>
              <span class="level-count" id="level-count-L3">0</span>
            </div>
            <div class="level-tab" data-level="L4" onclick="selectLevel('L4')">
              <span class="level-name">L4</span>
              <span class="level-count" id="level-count-L4">0</span>
            </div>
          </div>
        </div>

        <!-- Sorting Options -->
        <div style="display: flex; gap: 10px; align-items: center;">
          <label style="color: var(--text-secondary); font-size: 0.85rem;">Sort by:</label>
          <select id="sort-selector" onchange="changeSortOrder()" style="
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.85rem;
            cursor: pointer;
          ">
            <option value="recent">Most Recent</option>
            <option value="accessed">Most Accessed</option>
            <option value="oldest">Oldest First</option>
          </select>
        </div>
      </div>

      <!-- Level Description -->
      <div class="level-description" id="level-description">
        <strong>L0 - Raw Events:</strong> Unprocessed events from conversations. Includes user prompts, agent responses, and tool observations.
      </div>

      <!-- Events List -->
      <div id="level-events-list">
        <div class="loading-spinner">Loading...</div>
      </div>

      <!-- Load More Button -->
      <button class="load-more-btn" id="load-more-btn" onclick="loadMoreEvents()" style="display: none;">
        Load More Events
      </button>

      <!-- Graduation Controls -->
      <div class="graduation-section" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="font-size: 1rem; color: var(--text-secondary);">üéì Graduation Pipeline</h3>
          <button class="refresh-btn" id="run-graduation-btn" onclick="runGraduation()" style="padding: 8px 16px; font-size: 0.85rem;">
            <span id="graduation-icon">‚ö°</span> Run Graduation
          </button>
        </div>
        <div class="graduation-criteria" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
          <div class="criteria-card" style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">L0 ‚Üí L1</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ‚Ä¢ Access: ‚â•1<br>
              ‚Ä¢ Confidence: ‚â•50%<br>
              ‚Ä¢ Cross-session: 0
            </div>
          </div>
          <div class="criteria-card" style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">L1 ‚Üí L2</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ‚Ä¢ Access: ‚â•3<br>
              ‚Ä¢ Confidence: ‚â•70%<br>
              ‚Ä¢ Cross-session: ‚â•1
            </div>
          </div>
          <div class="criteria-card" style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">L2 ‚Üí L3</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ‚Ä¢ Access: ‚â•5<br>
              ‚Ä¢ Confidence: ‚â•85%<br>
              ‚Ä¢ Cross-session: ‚â•2
            </div>
          </div>
          <div class="criteria-card" style="background: var(--bg-card); padding: 12px; border-radius: 8px;">
            <div style="color: var(--accent); font-weight: 600; margin-bottom: 8px;">L3 ‚Üí L4</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ‚Ä¢ Access: ‚â•10<br>
              ‚Ä¢ Confidence: ‚â•92%<br>
              ‚Ä¢ Cross-session: ‚â•3
            </div>
          </div>
        </div>
        <div id="graduation-result" style="margin-top: 12px; display: none;"></div>
      </div>
    </div>

    <div class="main-grid">
      <div class="section">
        <h2 class="section-title">üìã Recent Sessions</h2>
        <ul class="session-list" id="session-list">
          <li class="loading-spinner">Loading...</li>
        </ul>
      </div>

      <div class="section">
        <h2 class="section-title">üåê Shared Knowledge</h2>
        <div id="shared-stats">
          <div class="shared-item">
            <div class="shared-type">
              <span class="shared-icon">üîß</span>
              <span>Troubleshooting</span>
            </div>
            <span class="shared-count" id="shared-troubleshooting">0</span>
          </div>
          <div class="shared-item">
            <div class="shared-type">
              <span class="shared-icon">‚ú®</span>
              <span>Best Practices</span>
            </div>
            <span class="shared-count" id="shared-best-practices">0</span>
          </div>
          <div class="shared-item">
            <div class="shared-type">
              <span class="shared-icon">‚ö†Ô∏è</span>
              <span>Common Errors</span>
            </div>
            <span class="shared-count" id="shared-errors">0</span>
          </div>
        </div>

        <h3 class="section-title" style="margin-top: 24px;">‚ôæÔ∏è Endless Mode</h3>
        <div id="endless-status">
          <div class="endless-status">
            <div class="status-indicator inactive" id="endless-indicator"></div>
            <span id="endless-mode-text">Loading...</span>
          </div>
          <div id="endless-details" style="display: none;">
            <div style="margin-bottom: 12px;">
              <span style="color: var(--text-secondary);">Continuity Score</span>
              <div class="progress-bar">
                <div class="progress-fill" id="continuity-bar" style="width: 0%"></div>
              </div>
            </div>
            <div style="display: flex; justify-content: space-between; color: var(--text-secondary); font-size: 0.85rem;">
              <span>Working Set: <strong id="working-set-size">0</strong></span>
              <span>Consolidated: <strong id="consolidated-count">0</strong></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="section" style="margin-top: 30px;">
      <h2 class="section-title">üî• Most Referenced Memories</h2>
      <div id="most-accessed-list">
        <div class="loading-spinner">Loading...</div>
      </div>
    </div>

    <div class="timeline-container section" style="margin-top: 30px;">
      <h2 class="section-title">üìä Activity Timeline (Last 7 Days)</h2>
      <div class="timeline-bar" id="timeline-bar">
        <!-- Filled by JS -->
      </div>
      <div class="timeline-labels" id="timeline-labels">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    let refreshInterval = null;

    // Level Explorer State
    let currentLevel = 'L0';
    let currentOffset = 0;
    const pageSize = 20;
    let hasMoreEvents = false;
    let sortOrder = 'recent';

    const LEVEL_DESCRIPTIONS = {
      L0: '<strong>L0 - Raw Events:</strong> Unprocessed events from conversations. Includes user prompts, agent responses, and tool observations.',
      L1: '<strong>L1 - Structured:</strong> Events that have been analyzed and structured. Contains session summaries and extracted patterns.',
      L2: '<strong>L2 - Validated:</strong> Type candidates with validated schemas. Events that have been cross-referenced and verified.',
      L3: '<strong>L3 - Verified:</strong> Cross-session validated knowledge. High-confidence information verified across multiple sessions.',
      L4: '<strong>L4 - Active:</strong> Indexed and readily searchable memories. The most refined and accessible knowledge.'
    };

    async function fetchStats() {
      try {
        const response = await fetch(`${API_BASE}/stats`);
        if (!response.ok) throw new Error('Failed to fetch stats');
        return await response.json();
      } catch (error) {
        console.error('Stats fetch error:', error);
        return null;
      }
    }

    async function fetchSharedStats() {
      try {
        const response = await fetch(`${API_BASE}/stats/shared`);
        if (!response.ok) throw new Error('Failed to fetch shared stats');
        return await response.json();
      } catch (error) {
        console.error('Shared stats fetch error:', error);
        return null;
      }
    }

    async function fetchEndlessStatus() {
      try {
        const response = await fetch(`${API_BASE}/stats/endless`);
        if (!response.ok) throw new Error('Failed to fetch endless status');
        return await response.json();
      } catch (error) {
        console.error('Endless status fetch error:', error);
        return null;
      }
    }

    async function fetchSessions() {
      try {
        const response = await fetch(`${API_BASE}/sessions?limit=10`);
        if (!response.ok) throw new Error('Failed to fetch sessions');
        return await response.json();
      } catch (error) {
        console.error('Sessions fetch error:', error);
        return null;
      }
    }

    async function fetchTimeline() {
      try {
        const response = await fetch(`${API_BASE}/stats/timeline?days=7`);
        if (!response.ok) throw new Error('Failed to fetch timeline');
        return await response.json();
      } catch (error) {
        console.error('Timeline fetch error:', error);
        return null;
      }
    }

    async function fetchMostAccessed() {
      try {
        const response = await fetch(`${API_BASE}/stats/most-accessed?limit=10`);
        if (!response.ok) throw new Error('Failed to fetch most accessed');
        return await response.json();
      } catch (error) {
        console.error('Most accessed fetch error:', error);
        return null;
      }
    }

    async function fetchLevelEvents(level, offset = 0) {
      try {
        const response = await fetch(`${API_BASE}/stats/levels/${level}?limit=${pageSize}&offset=${offset}&sort=${sortOrder}`);
        if (!response.ok) throw new Error('Failed to fetch level events');
        return await response.json();
      } catch (error) {
        console.error('Level events fetch error:', error);
        return null;
      }
    }

    function changeSortOrder() {
      const selector = document.getElementById('sort-selector');
      sortOrder = selector.value;
      loadLevelEvents(currentLevel, true);
    }

    function selectLevel(level) {
      currentLevel = level;
      currentOffset = 0;

      // Update tab styles
      document.querySelectorAll('.level-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.level === level);
      });

      // Update pipeline visualization
      document.querySelectorAll('.pipeline-step').forEach(step => {
        step.classList.toggle('active', step.dataset.level === level);
      });

      // Update description
      document.getElementById('level-description').innerHTML = LEVEL_DESCRIPTIONS[level];

      // Load events for this level
      loadLevelEvents(level, true);
    }

    async function loadLevelEvents(level, reset = false) {
      const container = document.getElementById('level-events-list');
      const loadMoreBtn = document.getElementById('load-more-btn');

      if (reset) {
        currentOffset = 0;
        container.innerHTML = '<div class="loading-spinner">Loading...</div>';
      }

      const data = await fetchLevelEvents(level, currentOffset);

      if (!data || !data.events) {
        if (reset) {
          container.innerHTML = '<div class="empty-state">Failed to load events</div>';
        }
        loadMoreBtn.style.display = 'none';
        return;
      }

      if (data.events.length === 0 && reset) {
        container.innerHTML = `<div class="empty-state">No events at level ${level} yet</div>`;
        loadMoreBtn.style.display = 'none';
        return;
      }

      const eventsHtml = data.events.map(event => {
        const typeClass = event.eventType.replace('_', '-');
        const time = formatTimeAgo(event.timestamp);
        const accessCount = event.accessCount || 0;
        const accessBadge = accessCount > 0 ? `<span style="background: var(--accent); color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">üëÅ ${accessCount}</span>` : '';

        return `
          <div class="event-card">
            <div>
              <span class="event-type ${event.eventType}">${event.eventType}</span>
              <span style="color: var(--text-secondary); font-size: 0.85rem;">${time}</span>
              ${accessBadge}
              <span style="color: var(--text-secondary); font-size: 0.75rem; margin-left: 8px;">
                Session: ${event.sessionId.slice(0, 8)}...
              </span>
            </div>
            <div class="event-content">${escapeHtml(event.content)}</div>
          </div>
        `;
      }).join('');

      if (reset) {
        container.innerHTML = eventsHtml;
      } else {
        container.innerHTML += eventsHtml;
      }

      hasMoreEvents = data.hasMore;
      loadMoreBtn.style.display = hasMoreEvents ? 'block' : 'none';
    }

    function loadMoreEvents() {
      currentOffset += pageSize;
      loadLevelEvents(currentLevel, false);
    }

    async function runGraduation() {
      const btn = document.getElementById('run-graduation-btn');
      const icon = document.getElementById('graduation-icon');
      const resultDiv = document.getElementById('graduation-result');

      btn.classList.add('loading');
      icon.textContent = '‚è≥';
      resultDiv.style.display = 'none';

      try {
        const response = await fetch('/api/stats/graduation/run', { method: 'POST' });
        const data = await response.json();

        if (data.success) {
          let message = `‚úÖ Evaluated ${data.evaluated} events, graduated ${data.graduated}`;
          if (data.graduated > 0 && Object.keys(data.byLevel).length > 0) {
            const levels = Object.entries(data.byLevel)
              .map(([level, count]) => `${level}: ${count}`)
              .join(', ');
            message += ` (${levels})`;
          }
          resultDiv.innerHTML = `<div style="padding: 12px; background: rgba(74, 222, 128, 0.1); border-radius: 8px; color: var(--success);">${message}</div>`;
          resultDiv.style.display = 'block';

          // Refresh data to show updated counts
          if (data.graduated > 0) {
            setTimeout(() => {
              refreshData();
            }, 500);
          }
        } else {
          resultDiv.innerHTML = `<div style="padding: 12px; background: rgba(233, 69, 96, 0.1); border-radius: 8px; color: var(--accent);">‚ùå ${data.error || 'Graduation failed'}</div>`;
          resultDiv.style.display = 'block';
        }
      } catch (error) {
        resultDiv.innerHTML = `<div style="padding: 12px; background: rgba(233, 69, 96, 0.1); border-radius: 8px; color: var(--accent);">‚ùå Error: ${error.message}</div>`;
        resultDiv.style.display = 'block';
      } finally {
        btn.classList.remove('loading');
        icon.textContent = '‚ö°';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function updateLevelCounts(stats) {
      if (!stats || !stats.levelStats) return;

      // Reset all counts to 0
      ['L0', 'L1', 'L2', 'L3', 'L4'].forEach(level => {
        const el = document.getElementById(`level-count-${level}`);
        if (el) el.textContent = '0';
      });

      // Update with actual counts
      stats.levelStats.forEach(stat => {
        const el = document.getElementById(`level-count-${stat.level}`);
        if (el) el.textContent = formatNumber(stat.count);
      });
    }

    async function searchMemories(query) {
      try {
        const response = await fetch(`${API_BASE}/search?q=${encodeURIComponent(query)}&limit=10`);
        if (!response.ok) throw new Error('Failed to search');
        return await response.json();
      } catch (error) {
        console.error('Search error:', error);
        return null;
      }
    }

    function formatNumber(num) {
      if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }

    function formatTimeAgo(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hr ago`;
      return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
    }

    function updateStats(stats) {
      if (!stats) return;

      document.getElementById('stat-events').textContent = formatNumber(stats.storage?.eventCount || 0);
      document.getElementById('stat-sessions').textContent = formatNumber(stats.sessions?.total || 0);
      document.getElementById('stat-vectors').textContent = formatNumber(stats.storage?.vectorCount || 0);
    }

    function updateSharedStats(stats) {
      if (!stats) {
        document.getElementById('stat-shared').textContent = '0';
        return;
      }

      const total = (stats.troubleshooting || 0) + (stats.bestPractices || 0) + (stats.commonErrors || 0);
      document.getElementById('stat-shared').textContent = formatNumber(total);
      document.getElementById('shared-troubleshooting').textContent = stats.troubleshooting || 0;
      document.getElementById('shared-best-practices').textContent = stats.bestPractices || 0;
      document.getElementById('shared-errors').textContent = stats.commonErrors || 0;
    }

    function updateEndlessStatus(status) {
      const indicator = document.getElementById('endless-indicator');
      const text = document.getElementById('endless-mode-text');
      const details = document.getElementById('endless-details');

      if (!status) {
        text.textContent = 'Unable to load';
        return;
      }

      if (status.mode === 'endless') {
        indicator.className = 'status-indicator active';
        text.textContent = 'Endless Mode Active';
        details.style.display = 'block';

        const continuityPercent = (status.continuityScore || 0) * 100;
        document.getElementById('continuity-bar').style.width = `${continuityPercent}%`;
        document.getElementById('working-set-size').textContent = status.workingSetSize || 0;
        document.getElementById('consolidated-count').textContent = status.consolidatedCount || 0;
      } else {
        indicator.className = 'status-indicator inactive';
        text.textContent = 'Session Mode (Endless Mode Disabled)';
        details.style.display = 'none';
      }
    }

    function updateSessions(sessions) {
      const container = document.getElementById('session-list');

      if (!sessions || sessions.length === 0) {
        container.innerHTML = '<li class="empty-state">No sessions found</li>';
        return;
      }

      container.innerHTML = sessions.map(session => {
        // Handle both API formats: id/sessionId, lastEventAt/lastActivity
        const sessionId = session.id || session.sessionId || 'unknown';
        const lastTime = session.lastEventAt || session.lastActivity || session.startedAt || session.startTime;
        const eventCount = session.eventCount || 0;

        return `
          <li class="session-item">
            <div class="session-header">
              <span class="session-id">${sessionId.slice(0, 16)}...</span>
              <span class="session-time">${formatTimeAgo(lastTime)}</span>
            </div>
            <div class="session-meta">
              <span>üìù ${eventCount} events</span>
            </div>
          </li>
        `;
      }).join('');
    }

    function updateTimeline(timeline) {
      const bar = document.getElementById('timeline-bar');
      const labels = document.getElementById('timeline-labels');

      if (!timeline || !timeline.daily || timeline.daily.length === 0) {
        bar.innerHTML = '<div class="empty-state">No activity data</div>';
        labels.innerHTML = '';
        return;
      }

      const maxTotal = Math.max(...timeline.daily.map(d => d.total), 1);

      bar.innerHTML = timeline.daily.map(day => {
        const height = Math.max(4, (day.total / maxTotal) * 100);
        const date = new Date(day.date).toLocaleDateString('en-US', { weekday: 'short' });
        return `
          <div
            class="timeline-day"
            style="height: ${height}%"
            data-tooltip="${date}: ${day.total} events"
          ></div>
        `;
      }).join('');

      const firstDate = new Date(timeline.daily[0].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      const lastDate = new Date(timeline.daily[timeline.daily.length - 1].date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      labels.innerHTML = `<span>${firstDate}</span><span>${lastDate}</span>`;
    }

    function updateMostAccessed(data) {
      const container = document.getElementById('most-accessed-list');

      if (!data || !data.memories || data.memories.length === 0) {
        container.innerHTML = '<div class="empty-state">No memory access data yet. Memories will appear here as they are referenced.</div>';
        return;
      }

      container.innerHTML = data.memories.map(memory => {
        const accessBars = '‚ñà'.repeat(Math.min(10, memory.accessCount));
        const accessEmpty = '‚ñë'.repeat(Math.max(0, 10 - memory.accessCount));
        const lastAccessed = memory.lastAccessed ? formatTimeAgo(memory.lastAccessed) : 'Never';

        return `
          <div class="session-item">
            <div class="session-header">
              <span class="session-id">üß† ${memory.topics?.slice(0, 2).join(', ') || 'Memory'}</span>
              <span class="session-time">${lastAccessed}</span>
            </div>
            <div style="margin: 8px 0;">
              <span style="color: var(--text-secondary); font-size: 0.85rem;">Access count:</span>
              <span style="font-family: monospace; color: var(--accent);">[${accessBars}${accessEmpty}] ${memory.accessCount}</span>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 8px;">
              ${memory.summary?.slice(0, 150) || 'No summary'}${memory.summary?.length > 150 ? '...' : ''}
            </p>
          </div>
        `;
      }).join('');
    }

    function showSearchResults(results) {
      const container = document.getElementById('search-results');
      const content = document.getElementById('search-results-content');

      if (!results || results.length === 0) {
        content.innerHTML = '<div class="empty-state">No results found</div>';
        container.style.display = 'block';
        return;
      }

      content.innerHTML = results.map(result => `
        <div class="session-item">
          <div class="session-header">
            <span class="session-id">${result.eventType || 'memory'}</span>
            <span class="session-time">Score: ${(result.score * 100).toFixed(0)}%</span>
          </div>
          <p style="color: var(--text-secondary); margin-top: 8px;">
            ${result.content?.slice(0, 200) || 'No content'}${result.content?.length > 200 ? '...' : ''}
          </p>
        </div>
      `).join('');

      container.style.display = 'block';
    }

    let searchTimeout = null;
    function handleSearch(event) {
      const query = event.target.value.trim();

      if (searchTimeout) clearTimeout(searchTimeout);

      if (!query) {
        document.getElementById('search-results').style.display = 'none';
        return;
      }

      searchTimeout = setTimeout(async () => {
        const results = await searchMemories(query);
        showSearchResults(results?.results || results || []);
      }, 300);
    }

    async function refreshData() {
      const btn = document.querySelector('.refresh-btn');
      btn.classList.add('loading');
      document.getElementById('refresh-icon').textContent = '‚è≥';

      try {
        const [stats, sharedStats, endlessStatus, sessions, timeline, mostAccessed] = await Promise.all([
          fetchStats(),
          fetchSharedStats(),
          fetchEndlessStatus(),
          fetchSessions(),
          fetchTimeline(),
          fetchMostAccessed()
        ]);

        updateStats(stats);
        updateSharedStats(sharedStats);
        updateEndlessStatus(endlessStatus);
        updateSessions(sessions?.sessions || sessions || []);
        updateTimeline(timeline);
        updateMostAccessed(mostAccessed);
        updateLevelCounts(stats);
        loadLevelEvents(currentLevel, true);
      } catch (error) {
        console.error('Refresh error:', error);
      } finally {
        btn.classList.remove('loading');
        document.getElementById('refresh-icon').textContent = 'üîÑ';
      }
    }

    // Initial load
    refreshData();

    // Auto-refresh every 30 seconds
    refreshInterval = setInterval(refreshData, 30000);
  </script>
</body>
</html>
